blueprint:
  name: Bed Time v3.2
  description: "Controls lights and loops media playback based on an input boolean."
  domain: automation
  input:
    input_boolean:
      name: Input Boolean
      description: "The boolean that controls the automation."
      selector:
        entity:
          domain: input_boolean
    media_player:
      name: Media Player
      description: "The media player to control."
      selector:
        entity:
          domain: media_player
    media_clip:
      name: MP3 File
      description: "Select an MP3 file to play."
      selector:
        media:
          entity_id: !input media_player
          filter:
            - media_content_type: music
    lights:
      name: Lights
      description: "Lights to toggle based on the boolean."
      selector:
        entity:
          domain: light
          multiple: true

mode: restart

trigger:
  - platform: state
    entity_id: !input input_boolean

action:
  - if:
      - condition: state
        entity_id: !input input_boolean
        state: "on"
    then:
      - service: light.turn_off
        target:
          entity_id: !input lights

      - repeat:
          sequence:
            - service: media_player.play_media
              target:
                entity_id: !input media_player
              data:
                media_content_id: !input media_clip
                media_content_type: "audio/mpeg"
              metadata:
                title: "{{ input.media_clip }}"
                thumbnail: null
                media_class: music
                children_media_class: null
                navigateIds:
                  - {}
                  - media_content_type: app
                    media_content_id: media-source://media_source
          until:
            - condition: state
              entity_id: !input input_boolean
              state: "off"

  - if:
      - condition: state
        entity_id: !input input_boolean
        state: "off"
    then:
      - service: media_player.media_stop
        target:
          entity_id: !input media_player
      - service: light.turn_on
        target:
          entity_id: !input lights
