blueprint:
  name: Wood Stove State Tracker v1.6
  description: Tracks the state of a wood stove based on temperature sensor input with five states.
  domain: automation
  input:
    temperature_sensor:
      name: Temperature Sensor
      description: The sensor measuring the wood stove temperature.
      selector:
        entity:
          domain: sensor
          device_class: temperature
    fire_starting_threshold:
      name: Fire Starting Threshold
      description: Temperature at which the stove is considered to be starting a fire.
      default: 100
      selector:
        number:
          min: 80
          max: 200
          unit_of_measurement: "째F"
    warming_threshold:
      name: Warming Threshold
      description: Temperature at which the stove is considered warming up.
      default: 120
      selector:
        number:
          min: 100
          max: 350
          unit_of_measurement: "째F"
    burning_threshold:
      name: Burning Threshold
      description: Temperature at which the stove is actively burning.
      default: 250
      selector:
        number:
          min: 120
          max: 500
          unit_of_measurement: "째F"
    cooling_threshold:
      name: Cooling Threshold
      description: Temperature at which the stove is considered cooling down.
      default: 200
      selector:
        number:
          min: 50
          max: 300
          unit_of_measurement: "째F"
    stove_state_helper:
      name: Stove State Helper
      description: An input_select to track the state.
      selector:
        entity:
          domain: input_select

mode: restart
max_exceeded: silent

trigger:
  - platform: numeric_state
    entity_id: !input temperature_sensor
    above: !input fire_starting_threshold
    id: "fire_starting"
  - platform: numeric_state
    entity_id: !input temperature_sensor
    above: !input warming_threshold
    id: "warming_up"
  - platform: numeric_state
    entity_id: !input temperature_sensor
    above: !input burning_threshold
    id: "burning"
  - platform: numeric_state
    entity_id: !input temperature_sensor
    below: !input cooling_threshold
    id: "cooling_down"
  - platform: numeric_state
    entity_id: !input temperature_sensor
    below: !input fire_starting_threshold
    id: "off"

condition:
  - condition: template
    value_template: >
      {% set current_state = states(input_select.stove_state_helper) %}
      {% if trigger.id == "cooling_down" %}
        {{ current_state in ["Burning", "Warming Up"] }}
      {% elif trigger.id == "warming_up" %}
        {{ current_state in ["Cooling Down", "Fire Starting", "Off"] }}
      {% elif trigger.id == "burning" %}
        {{ current_state in ["Warming Up"] }}
      {% elif trigger.id == "fire_starting" %}
        {{ current_state == "Off" }}
      {% elif trigger.id == "off" %}
        {{ current_state == "Cooling Down" }}
      {% else %}
        true
      {% endif %}

action:
  - choose:
      - conditions:
          - condition: trigger
            id: "fire_starting"
        sequence:
          - service: input_select.select_option
            target:
              entity_id: !input stove_state_helper
            data:
              option: "Fire Starting"
      - conditions:
          - condition: trigger
            id: "warming_up"
        sequence:
          - service: input_select.select_option
            target:
              entity_id: !input stove_state_helper
            data:
              option: "Warming Up"
      - conditions:
          - condition: trigger
            id: "burning"
        sequence:
          - service: input_select.select_option
            target:
              entity_id: !input stove_state_helper
            data:
              option: "Burning"
      - conditions:
          - condition: trigger
            id: "cooling_down"
        sequence:
          - service: input_select.select_option
            target:
              entity_id: !input stove_state_helper
            data:
              option: "Cooling Down"
      - conditions:
          - condition: trigger
            id: "off"
        sequence:
          - service: input_select.select_option
            target:
              entity_id: !input stove_state_helper
            data:
              option: "Off"
